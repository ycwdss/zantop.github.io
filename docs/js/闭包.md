# 闭包

主要分三部分说：
一、什么是闭包？二、闭包有什么好处？应用在哪里？三、闭包需要注意的地方？

## 1、什么是闭包

第一个特点：可以是函数嵌套函数

```javascript
function fna() {
  function fnb() {}
}
```

<!--more-->

第二个特点：内部函数可以引用外部函数的参数和变量

```javascript
function fna() {
  var b = 5;
  function fnb() {
    console.log(b);
  }
  fnb();
}
fna();
```

b 变量都要被内部函数 fnb()引用到，会一直驻扎在内存中，不会被垃圾回收的，也就是说参数和变量不会被垃圾回收机制所收回。
那么什么是 js 垃圾回收机制呢？

```javascript
function fna() {
  var a = 1;
}
fna();
```

例如，上面写了个普通函数 fna(),当 fna();执行完毕后变量 a 就不存在了，为了节省内存。
例 1：

```javascript
function fna() {
  var a = 5;
  function fnb() {
    console.log(a);
  }
  return fnb;
}
var fnc = fna();
fnc(); //5
```

变量 c 就是返回的 fnb 函数，fnc()执行的时候 变量 a 并没有消失，一直驻扎在内存中的，这时会弹出 5 的.这就是简单的闭包形式。

## 2、闭包的好处和应用

好处： 1.希望一个变量长期驻扎在内存当中 2.避免全局变量的污染

```javascript
var a = 1;
function fna() {
  a++;
  console.log(a);
}
fna(); //2
fna(); //3
console.log(a); //3
```

a 是个全局变量，一直驻扎在内存中，依次执行会累加。

```javascript
function fna() {
  var a = 1;
  a++;
  console.log(a);
}
fna(); //2
fna(); //2
```

如果把变量 a 设置为局部变量，每调用一次代码重新执行，调用后 a 就不存在，下次调用的时候 a 还是 1；那么怎么能做到 a 即是局部变量，a 又能累计呢？
这就是闭包所能做到的。
例 2:

```javascript
function fna() {
  var a = 1;
  return function () {
    a++;
    console.log(a);
  };
}
var fnb = fna();
fnb(); //2
fnb(); //3
console.log(a); //undfined
```

构成了函数嵌套函数，当外面的函数执行完毕后，内部函数依旧可以调用到变量 a;

```javascript
(function () {
  console.log(1);
})();
```

()放函数，函数声明就会变成函数表达式，再加（）立即执行。
至此可以把例 2 中的代码改写一下.

```javascript
var fna = (function () {
  var a = 1;
  return function () {
    a++;
    console.log(a);
  };
})();
fna(); //2
fna(); //3
```

var a=1 在外面是调用不到，减少全局变量的污染，把内部函数变为私有的，

这也就是 3.变量私有

```javascript
var aaa = (function () {
  var a = 1;
  function bbb() {
    a++;
    console.log(a);
  }
  function ccc() {
    a++;
    console.log(a);
  }
  return {
    b: bbb,
    c: ccc,
  };
})();
//aaa.b();  //2
//aaa.c();  //3
```

在循环中直接找到对应元素的索引

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <ul>
      <li>11111111111</li>
      <li>11111111111</li>
      <li>11111111111</li>
    </ul>

    <script>
      window.onload = function () {
        var aLi = document.getElementsByTagName('li');

        for (var i = 0; i < aLi.length; i++) {
          aLi[i].onclick = function () {
            console.log(i); //3
          };
        }
      };
    </script>
  </body>
</html>
```

console.log(i)弹出 3,为什么呢?很明显，当循环执行结束的时候

```javascript
aLi[i].onclick = function () {
  console.log(i); //3
};
```

还没执行，当点击的时候才会执行，但此时 i 已经变成 3 了。可以利用闭包改写，可以把循环中的 i 当作个参数传进去，就之前所说的内部函数可以引用外部函数的参数和变量。

```javascript
for(var i=0;i<aLi.length;i++){
(function(i){
aLi[i].onclick = function(){
console.log(i);
};
})(i);
```

把 i 当成参数穿进去。除了这种写法还有另外一种方式

```javascript
for(var i=0;i<aLi.length;i++){
aLi[i].onclick = (function(i){
    return function(){
    console.log(i);
}
})(i);
```

## 3、闭包需要注意的 IE 下会引发内存泄漏.

[「每日一题」JS 中的闭包是什么？](https://zhuanlan.zhihu.com/p/22486908)
